<app-page-header
  title="Счета и платежи"
  description="Просматривайте все свои счета и платежи и убедитесь, что вы получаете оплату счетов вовремя."
>
  <div action>
    <button
      class="tui-space_left-5"
      tuiButton
      size="m"
      icon="tuiIconPlus"
      title="Создать новый"
      [routerLink]="[routing.admin.invoice.create]"
      [queryParams]="{ lastIndex: (lastIndex$ | async)?.number }"
      [disabled]="(indicator$ | async)?.loading || !(contractor$ | async)"
    >
      Создать новый
    </button>
    <button
      class="tui-space_left-5"
      tuiIconButton
      size="m"
      icon="tuiIconAttention"
      [disabled]="true"
    ></button>
  </div>
</app-page-header>

<ng-container *ngIf="isViewInit">
  <section
    class="page-body"
    fluidHeight
    *tuiLet="invoices$ | async as invoices"
  >
    <app-empty-panel
      [link]="(contractor$ | async) ? routing.admin.invoice.create : ''"
      *ngIf="!invoices?.length"
    ></app-empty-panel>

    <tui-scrollbar *ngIf="invoices?.length">
      <section class="tui-container tui-container_full">
        <div class="tui-row tui-row_adaptive">
          <div class="tui-col_xs-12 tui-col_s-12 tui-col_sm-12 tui-col_md-12">
            <!-- Tabs -->
            <tui-tabs-with-more
              class="page-tabs tui-space_bottom-5"
              [activeItemIndex]="getTabActiveIndex"
              [moreContent]="more"
            >
              <ng-container *ngFor="let tab of tabs">
                <button
                  *tuiTab
                  tuiTab
                  (click)="selectTab(tab)"
                  [disabled]="tab.disabled"
                >
                  {{ tab.name }}
                </button>
              </ng-container>
            </tui-tabs-with-more>

            <!-- Tabls -->
            <table
              tuiTable
              [columns]="columns"
              class="tui-table tui-space_bottom-5"
            >
              <thead>
                <tr tuiThGroup class="tui-table__tr">
                  <th
                    class="tui-table__th"
                    *tuiHead="'number'"
                    tuiTh
                    [resizable]="true"
                  >
                    Номер
                  </th>
                  <th
                    class="tui-table__th"
                    *tuiHead="'date'"
                    tuiTh
                    [resizable]="true"
                  >
                    Дата
                  </th>
                  <th
                    class="tui-table__th"
                    *tuiHead="'status'"
                    tuiTh
                    [resizable]="true"
                  >
                    Статус
                  </th>
                  <th
                    class="tui-table__th"
                    *tuiHead="'price'"
                    tuiTh
                    [resizable]="true"
                  >
                    Сумма
                  </th>
                  <th
                    class="tui-table__th"
                    *tuiHead="'action'"
                    tuiTh
                    [resizable]="true"
                  ></th>
                </tr>
              </thead>
              <tbody tuiTbody [data]="invoices">
                <tr
                  *tuiRow="let item of invoices; let index = index"
                  tuiTr
                  class="tui-table__tr"
                >
                  <td class="tui-table__td" *tuiCell="'number'" tuiTd>
                    № <b>{{ item?.number }}</b>
                  </td>
                  <td class="tui-table__td" *tuiCell="'date'" tuiTd>
                    <b
                      >{{ item?.dateRange.from | date: 'dd MMM yyyy' }} -
                      {{ item?.dateRange.to | date: 'dd MMM yyyy' }}</b
                    >
                  </td>
                  <td class="tui-table__td" *tuiCell="'status'" tuiTd>
                    <tui-badge
                      [class]="getStatusClass(item.status)"
                      status="custom"
                      [value]="item?.status?.name"
                      *ngIf="item?.status"
                    ></tui-badge>
                    <span *ngIf="!item?.status">не указан</span>
                  </td>
                  <td class="tui-table__td" *tuiCell="'price'" tuiTd>
                    <b>
                      {{
                        item?.total?.totalSum?.amount | tuiFormatNumber: 2:','
                      }}
                    </b>
                    {{ 'BYN' | tuiCurrency }}
                  </td>
                  <td
                    class="tui-table__td tui-table__td--right"
                    *tuiCell="'action'"
                    tuiTd
                  >
                    <button
                      tuiIconButton
                      appearance="flat"
                      size="s"
                      icon="tuiIconDownload"
                      title="Скачать PDF"
                      shape="rounded"
                      [disabled]="(indicator$ | async)?.loading"
                      (click)="downloadPdf(item)"
                    ></button>
                    <button
                      tuiIconButton
                      appearance="flat"
                      size="s"
                      icon="tuiIconCopy"
                      title="Создать дубликат"
                      shape="rounded"
                      [routerLink]="[routing.admin.invoice.clone]"
                      [queryParams]="{
                        cloneId: item._id,
                        lastIndex: (lastIndex$ | async)?.number
                      }"
                    ></button>
                    <tui-hosted-dropdown #dropdown [content]="content">
                      <button
                        tuiIconButton
                        appearance="flat"
                        size="s"
                        icon="tuiIconMoreVer"
                        type="button"
                        shape="rounded"
                        [disabled]="(indicator$ | async)?.loading"
                        [pseudoHovered]="dropdown.open || null"
                      ></button>
                    </tui-hosted-dropdown>
                    <ng-template #content let-activeZone>
                      <tui-data-list
                        tuiDataListDropdownManager
                        [tuiActiveZoneParent]="activeZone"
                      >
                        <tui-opt-group>
                          <button
                            tuiOption
                            (click)="createBaseOnContract(item)"
                            [disabled]="item._contractId"
                          >
                            Договор
                          </button>
                          <button
                            tuiOption
                            (click)="createBaseOnAct(item)"
                            [disabled]="false"
                          >
                            Акт
                          </button>
                          <button
                            tuiOption
                            (click)="createBaseOnReference(item)"
                            [disabled]="item._rentalCertificateId"
                          >
                            Справка
                          </button>
                        </tui-opt-group>
                        <tui-opt-group>
                          <button
                            tuiOption
                            [routerLink]="[
                              routing.admin.invoice.edit,
                              item._id
                            ]"
                          >
                            Изменить
                          </button>
                          <button
                            class="btn-delete"
                            tuiOption
                            (click)="openDeleteModal(item, dialogDelete)"
                            [disabled]="(indicator$ | async)?.loading"
                          >
                            Удалить
                          </button>
                        </tui-opt-group>
                      </tui-data-list>
                    </ng-template>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </tui-scrollbar>
  </section>
</ng-container>

<ng-template #more>
  <tui-svg src="tuiIconMoreHorLarge"></tui-svg>
</ng-template>

<ng-template #dialogDelete let-observer>
  <section class="modal-dialog">
    <p>
      Вы действительно хотите удалить счёт: №
      <b>{{ selectedInvoice?.number }}</b>
      от <b>{{ selectedInvoice?.date | date: 'dd MMM yyyy' }}</b> ?
    </p>
    <div class="modal-dialog__actions">
      <button
        tuiButton
        type="button"
        size="m"
        appearance="outline"
        (click)="observer.complete()"
      >
        Отменить
      </button>
      <button
        tuiButton
        type="button"
        appearance="accent"
        size="m"
        class="tui-space_left-3"
        (click)="delete(selectedInvoice); observer.complete()"
      >
        Удалить
      </button>
    </div>
  </section>
</ng-template>
